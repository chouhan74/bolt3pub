{% extends "base.html" %}

{% block title %}{{ question.title }} - Assessment{% endblock %}

{% block extra_head %}
  <!-- Monaco AMD loader -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs/loader.min.js"></script>

  <style>
    .split-view { display: grid; grid-template-columns: 1fr 1fr; height: calc(100vh - 64px); }
    .problem-statement { overflow-y: auto; border-right: 1px solid #e5e7eb; }
    .code-panel { display: flex; flex-direction: column; }
    .editor-container { flex: 1; border-bottom: 1px solid #e5e7eb; min-height: 320px; }
    .console-panel { height: 220px; overflow-y: auto; background: #1e1e1e; color: #d4d4d4; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    pre code { background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; display: block; overflow-x: auto; }
    .test-case { background: #f8f9fa; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin: 1rem 0; }
  </style>

  <script>
    /* requestIdleCallback polyfill (for Safari / older browsers) */
    window.requestIdleCallback = window.requestIdleCallback || function (cb) {
      return setTimeout(function () { cb({ didTimeout: false, timeRemaining: function () { return 0; } }); }, 1);
    };
    window.cancelIdleCallback = window.cancelIdleCallback || function (id) { clearTimeout(id); };
  </script>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-white" x-data="questionApp()" x-init="init()">
  <!-- Header -->
  <div class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center">
          <a href="/candidate/assessment/{{ assessment_candidate.id }}" class="text-blue-600 hover:text-blue-800 mr-4">
            <i class="fas fa-arrow-left"></i>
          </a>
          <div>
            <h1 class="text-lg font-semibold text-gray-900">{{ question.title }}</h1>
            <div class="flex items-center space-x-2 text-sm text-gray-500">
              <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                {% if question.difficulty.value == 'easy' %} bg-green-100 text-green-800
                {% elif question.difficulty.value == 'medium' %} bg-yellow-100 text-yellow-800
                {% else %} bg-red-100 text-red-800 {% endif %}">
                {{ question.difficulty.value.title() }}
              </span>
              <span>{{ question.max_score }} points</span>
              <span>{{ question.time_limit_minutes }} minutes</span>
            </div>
          </div>
        </div>
        <div class="flex items-center space-x-2">
          {% set languages = question.allowed_languages.split(',') if question.allowed_languages else ['python'] %}
          <select x-model="selectedLanguage" @change="changeLanguage()" class="border border-gray-300 rounded px-3 py-1 text-sm">
            {% for lang in languages %}
              <option value="{{ lang.strip() }}">{{ lang.strip().title() }}</option>
            {% endfor %}
          </select>

          <button @click="runCode()" :disabled="isRunning || !editorReady"
                  class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-4 py-2 rounded text-sm transition-colors">
            <span x-show="!isRunning"><i class="fas fa-play mr-1"></i>Run Code</span>
            <span x-show="isRunning"><i class="fas fa-spinner fa-spin mr-1"></i>Running...</span>
          </button>

          <button @click="submitCode()" :disabled="isSubmitting || !editorReady"
                  class="bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-4 py-2 rounded text-sm transition-colors">
            <span x-show="!isSubmitting"><i class="fas fa-check mr-1"></i>Submit</span>
            <span x-show="isSubmitting"><i class="fas fa-spinner fa-spin mr-1"></i>Submitting...</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Split View -->
  <div class="split-view">
    <!-- Problem Statement -->
    <div class="problem-statement">
      <div class="p-6">
        <div class="prose max-w-none">
          <h2 class="text-xl font-bold mb-4">Problem Description</h2>
          <div class="mb-6">
            {{ question.description | safe }}
          </div>

          {% if public_test_cases %}
          <h3 class="text-lg font-semibold mb-3">Sample Test Cases</h3>
          {% for test_case in public_test_cases %}
          <div class="test-case p-4 mb-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <h4 class="font-semibold text-sm mb-2">Input:</h4>
                <pre class="bg-white border p-2 rounded text-sm font-mono">{{ test_case.input_data }}</pre>
              </div>
              <div>
                <h4 class="font-semibold text-sm mb-2">Output:</h4>
                <pre class="bg-white border p-2 rounded text-sm font-mono">{{ test_case.expected_output }}</pre>
              </div>
            </div>
          </div>
          {% endfor %}
          {% endif %}

          {% if question.tags %}
          <div class="mt-6">
            <h4 class="font-semibold mb-2">Tags:</h4>
            <div class="flex flex-wrap gap-2">
              {% set tags = question.tags.split(',') if question.tags else [] %}
              {% for tag in tags %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                {{ tag.strip() }}
              </span>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Code Editor -->
    <div class="code-panel">
      <div class="editor-container">
        <div id="editor" class="h-full"></div>
      </div>

      <!-- Console -->
      <div class="console-panel p-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm font-semibold text-gray-300">Console Output</h3>
          <button @click="clearConsole()" class="text-xs text-gray-400 hover:text-gray-200">
            <i class="fas fa-trash mr-1"></i>Clear
          </button>
        </div>
        <div class="text-sm whitespace-pre-wrap">
          <template x-if="!consoleOutput">
            <div class="text-gray-400 italic">Run your code to see output here...</div>
          </template>
          <div x-html="consoleOutput"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  /* Server data (safely serialized) */
  window.__QUESTION_ID__ = {{ question.id }};
  window.__QUESTION_MAX_SCORE__ = {{ question.max_score }};
  window.__INITIAL_CODE__ = {{ (latest_submission.code if latest_submission else question.template_code or '') | tojson }};
  window.__ALLOWED_LANGUAGES__ = {{ (question.allowed_languages.split(',') if question.allowed_languages else ['python']) | tojson }};

  function questionApp() {
    return {
      selectedLanguage: (window.__ALLOWED_LANGUAGES__[0] || 'python').trim(),
      editor: null,
      editorReady: false,
      isRunning: false,
      isSubmitting: false,
      isSaving: false,
      autoSaveInterval: null,
      autoSaveTimeout: null,
      consoleOutput: '',
      pollAborter: null,

      init() {
        this.initEditor();
        this.startAutoSave();
        this.setupProctoring();
        // Cleanup on navigate away
        window.addEventListener('beforeunload', () => {
          if (this.pollAborter) this.pollAborter.abort();
          if (this.autoSaveInterval) clearInterval(this.autoSaveInterval);
          if (this.autoSaveTimeout) clearTimeout(this.autoSaveTimeout);
        });
      },

      initEditor() {
        /* Configure Monaco base path */
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs' } });

        /* Defer heavy editor creation until browser is idle (prevents ‚ÄúPage Unresponsive‚Äù) */
        requestIdleCallback(() => {
          require(['vs/editor/editor.main'], () => {
            try {
              this.editor = monaco.editor.create(document.getElementById('editor'), {
                value: window.__INITIAL_CODE__ || '',
                language: this.getMonacoLanguage(this.selectedLanguage),
                theme: 'vs-light',
                automaticLayout: true,
                minimap: { enabled: false },
                fontSize: 14,
                lineNumbers: 'on',
                roundedSelection: false,
                scrollBeyondLastLine: false,
                readOnly: false,
                wordWrap: 'bounded'
              });
              this.editor.onDidChangeModelContent(() => this.scheduleAutoSave());
              this.editorReady = true;
            } catch (e) {
              console.error('Monaco init failed:', e);
              this.consoleOutput = `<div class="text-red-400">Editor failed to load. Please refresh.</div>`;
            }
          });
        });
      },

      getMonacoLanguage(lang) {
        const mapping = { python: 'python', cpp: 'cpp', c: 'c', java: 'java', javascript: 'javascript' };
        return mapping[(lang || '').toLowerCase()] || 'python';
      },

      changeLanguage() {
        if (this.editor) {
          monaco.editor.setModelLanguage(this.editor.getModel(), this.getMonacoLanguage(this.selectedLanguage));
        }
      },

      async runCode() {
        if (!this.editor || !this.editorReady) return;
        this.isRunning = true;
        this.consoleOutput = '<div class="text-blue-300">Running code...</div>';

        try {
          const code = this.editor.getValue();
          const res = await fetch('/api/execute-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              question_id: window.__QUESTION_ID__,
              code,
              language: this.selectedLanguage,
              run_type: 'test'
            })
          });

          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const result = await res.json();

          if (result.submission_id) {
            this.pollSubmissionStatus(result.submission_id, false);
          } else {
            this.consoleOutput = '<div class="text-red-400">Failed to start execution.</div>';
            this.isRunning = false;
          }
        } catch (err) {
          this.consoleOutput = `<div class="text-red-400">Error: ${err.message}</div>`;
          this.isRunning = false;
        }
      },

      async submitCode() {
        if (!this.editor || !this.editorReady) return;
        if (!confirm('Are you sure you want to submit this solution? This will be your final submission for this question.')) return;

        this.isSubmitting = true;
        this.consoleOutput = '<div class="text-green-300">Submitting solution...</div>';

        try {
          const code = this.editor.getValue();
          const res = await fetch('/api/execute-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              question_id: window.__QUESTION_ID__,
              code,
              language: this.selectedLanguage,
              run_type: 'submit'
            })
          });

          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const result = await res.json();

          if (result.submission_id) {
            this.pollSubmissionStatus(result.submission_id, true);
          } else {
            this.consoleOutput = '<div class="text-red-400">Failed to submit solution.</div>';
            this.isSubmitting = false;
          }
        } catch (err) {
          this.consoleOutput = `<div class="text-red-400">Error: ${err.message}</div>`;
          this.isSubmitting = false;
        }
      },

      pollSubmissionStatus(submissionId, isSubmission) {
        if (this.pollAborter) this.pollAborter.abort();
        this.pollAborter = new AbortController();

        let attempts = 0;
        const maxAttempts = 30;

        const tick = async () => {
          if (attempts++ >= maxAttempts) {
            this.consoleOutput = '<div class="text-red-400">Execution timeout</div>';
            this.isRunning = false;
            this.isSubmitting = false;
            return;
          }
          try {
            const res = await fetch(`/api/submission/${submissionId}/status`, { signal: this.pollAborter.signal });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const status = await res.json();

            if (status.status === 'completed') {
              this.displayResults(status, isSubmission);
              this.isRunning = false;
              this.isSubmitting = false;
            } else if (status.status === 'error') {
              this.consoleOutput = `<div class="text-red-400">Execution failed: ${status.runtime_error || 'Unknown error'}</div>`;
              this.isRunning = false;
              this.isSubmitting = false;
            } else {
              setTimeout(tick, 1000);
            }
          } catch (err) {
            if (err.name === 'AbortError') return;
            this.consoleOutput = `<div class="text-red-400">Error checking status: ${err.message}</div>`;
            this.isRunning = false;
            this.isSubmitting = false;
          }
        };
        tick();
      },

      displayResults(status, isSubmission) {
        let output = '';

        if (status.compilation_error) {
          output += `<div class="text-red-400 mb-2">Compilation Error:</div>`;
          output += `<div class="text-red-300 mb-4">${this.escapeHtml(status.compilation_error)}</div>`;
          this.consoleOutput = output;
          return;
        }

        if (isSubmission) {
          output += `<div class="text-green-400 mb-2">‚úÖ Submission Complete!</div>`;
          output += `<div class="text-white mb-2">Overall Verdict:
            <span class="font-bold ${this.getVerdictColor(status.overall_verdict)}">${this.escapeHtml(status.overall_verdict || '')}</span>
          </div>`;
          const total = Number(status?.total_score ?? 0);
          const maxS = Number(window.__QUESTION_MAX_SCORE__ ?? 0);
          output += `<div class="text-white mb-4">Score: ${total}/${maxS}</div>`;
        } else {
          output += `<div class="text-blue-400 mb-2">üîç Test Results (Public Test Cases Only):</div>`;
        }

        if (Array.isArray(status.results) && status.results.length) {
          status.results.forEach((r, idx) => {
            const verdictColor = this.getVerdictColor(r.verdict);
            output += `<div class="border-t border-gray-600 pt-2 mt-2">`;
            output += `<div class="text-gray-300">Test Case ${idx + 1}:
                        <span class="${verdictColor} font-bold">${this.escapeHtml(r.verdict || '')}</span></div>`;

            if (r.verdict === 'OK') {
              output += `<div class="text-green-400">‚úÖ Passed</div>`;
            } else if (r.verdict === 'WA') {
              output += `<div class="text-red-400">‚ùå Wrong Answer</div>`;
              if (r.actual_output) {
                output += `<div class="text-gray-300 text-xs">Your output:</div>`;
                output += `<div class="text-gray-400 text-xs font-mono bg-gray-800 p-1 rounded">${this.escapeHtml(String(r.actual_output)).substring(0, 500)}</div>`;
              }
            } else {
              output += `<div class="text-red-400">‚ùå ${this.escapeHtml(r.verdict || '')}</div>`;
              if (r.error_message) {
                output += `<div class="text-red-300 text-xs">${this.escapeHtml(r.error_message)}</div>`;
              }
            }

            output += `<div class="text-gray-400 text-xs">Time: ${Number(r.execution_time_ms || 0)}ms | Memory: ${Number(r.memory_used_kb || 0)}KB</div>`;
            output += `</div>`;
          });
        }

        this.consoleOutput = output;
      },

      escapeHtml(str) {
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      },

      getVerdictColor(v) {
        const colors = { OK: 'text-green-400', WA: 'text-red-400', TLE: 'text-yellow-400', MLE: 'text-yellow-400', RTE: 'text-red-400', CE: 'text-red-400' };
        return colors[v] || 'text-gray-400';
      },

      clearConsole() { this.consoleOutput = ''; },

      /* --- Auto-save with debounce + in-flight guard --- */
      startAutoSave() {
        this.autoSaveInterval = setInterval(() => this.performAutoSave(), 30000);
      },
      scheduleAutoSave() {
        if (this.autoSaveTimeout) clearTimeout(this.autoSaveTimeout);
        this.autoSaveTimeout = setTimeout(() => this.performAutoSave(), 1200);
      },
      async performAutoSave() {
        if (!this.editor || this.isSaving) return;
        this.isSaving = true;
        try {
          const code = this.editor.getValue();
          await fetch('/api/auto-save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question_id: window.__QUESTION_ID__, code })
          });
        } catch (e) {
          console.error('Auto-save failed:', e);
        } finally {
          this.isSaving = false;
        }
      },

      /* --- Lightweight proctoring with throttling --- */
      setupProctoring() {
        let lastEventTs = 0;
        const send = async (type, data) => {
          const now = Date.now();
          if (now - lastEventTs < 1000) return; // throttle 1s
          lastEventTs = now;
          try {
            await fetch('/api/proctoring-event', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ event_type: type, event_data: data })
            });
          } catch (_) { /* ignore */ }
        };

        document.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          send('right_click', { prevented: true });
        });

        document.addEventListener('keydown', (e) => {
          const suspiciousKeys = ['F12', 'F5'];
          const combos = [
            { ctrl: true, shift: true, key: 'I' },
            { ctrl: true, shift: true, key: 'C' },
            { ctrl: true, key: 'U' },
          ];

          if (suspiciousKeys.includes(e.key)) {
            e.preventDefault();
            send('key', { key: e.key });
          }
          for (const c of combos) {
            if (e.ctrlKey === !!c.ctrl && e.shiftKey === !!c.shift && e.key.toUpperCase() === c.key) {
              e.preventDefault();
              send('combo', c);
              break;
            }
          }
        });
      }
    }
  }
</script>
{% endblock %}
