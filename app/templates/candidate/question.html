{% extends "base.html" %}

{% block title %}{{ question.title }} - Assessment{% endblock %}

{% block extra_head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs/loader.min.js"></script>
<style>
    .split-view {
        display: grid;
        grid-template-columns: 1fr 1fr;
        height: calc(100vh - 64px);
    }
    
    .problem-statement {
        overflow-y: auto;
        border-right: 1px solid #e5e7eb;
    }
    
    .code-panel {
        display: flex;
        flex-direction: column;
    }
    
    .editor-container {
        flex: 1;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .console-panel {
        height: 200px;
        overflow-y: auto;
        background: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    }

    pre code {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 0.5rem;
        display: block;
        overflow-x: auto;
    }
    
    .test-case {
        background: #f8f9fa;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        margin: 1rem 0;
    }
</style>
{% endblock %}

{% block content %}
<!-- Question Interface -->
<div class="min-h-screen bg-white" x-data="questionApp()">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="/candidate/assessment/{{ assessment_candidate.id }}" class="text-blue-600 hover:text-blue-800 mr-4">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <div>
                        <h1 class="text-lg font-semibold text-gray-900">{{ question.title }}</h1>
                        <div class="flex items-center space-x-2 text-sm text-gray-500">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                                {% if question.difficulty.value == 'easy' %}
                                    bg-green-100 text-green-800
                                {% elif question.difficulty.value == 'medium' %}
                                    bg-yellow-100 text-yellow-800
                                {% else %}
                                    bg-red-100 text-red-800
                                {% endif %}
                            ">
                                {{ question.difficulty.value.title() }}
                            </span>
                            <span>{{ question.max_score }} points</span>
                            <span>{{ question.time_limit_minutes }} minutes</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <select x-model="selectedLanguage" @change="changeLanguage()" class="border border-gray-300 rounded px-3 py-1 text-sm">
                        {% set languages = question.allowed_languages.split(',') if question.allowed_languages else ['python'] %}
                        {% for lang in languages %}
                        <option value="{{ lang.strip() }}">{{ lang.strip().title() }}</option>
                        {% endfor %}
                    </select>
                    <button @click="runCode()" :disabled="isRunning" class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-4 py-2 rounded text-sm transition-colors">
                        <span x-show="!isRunning">
                            <i class="fas fa-play mr-1"></i>
                            Run Code
                        </span>
                        <span x-show="isRunning">
                            <i class="fas fa-spinner fa-spin mr-1"></i>
                            Running...
                        </span>
                    </button>
                    <button @click="submitCode()" :disabled="isSubmitting" class="bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-4 py-2 rounded text-sm transition-colors">
                        <span x-show="!isSubmitting">
                            <i class="fas fa-check mr-1"></i>
                            Submit
                        </span>
                        <span x-show="isSubmitting">
                            <i class="fas fa-spinner fa-spin mr-1"></i>
                            Submitting...
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Split View -->
    <div class="split-view">
        <!-- Problem Statement -->
        <div class="problem-statement">
            <div class="p-6">
                <div class="prose max-w-none">
                    <h2 class="text-xl font-bold mb-4">Problem Description</h2>
                    <div class="mb-6">
                        {{ question.description | safe }}
                    </div>

                    {% if public_test_cases %}
                    <h3 class="text-lg font-semibold mb-3">Sample Test Cases</h3>
                    {% for test_case in public_test_cases %}
                    <div class="test-case p-4 mb-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-semibold text-sm mb-2">Input:</h4>
                                <pre class="bg-white border p-2 rounded text-sm font-mono">{{ test_case.input_data }}</pre>
                            </div>
                            <div>
                                <h4 class="font-semibold text-sm mb-2">Output:</h4>
                                <pre class="bg-white border p-2 rounded text-sm font-mono">{{ test_case.expected_output }}</pre>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}

                    {% if question.tags %}
                    <div class="mt-6">
                        <h4 class="font-semibold mb-2">Tags:</h4>
                        <div class="flex flex-wrap gap-2">
                            {% set tags = question.tags.split(',') if question.tags else [] %}
                            {% for tag in tags %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                {{ tag.strip() }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Code Editor -->
        <div class="code-panel">
            <div class="editor-container">
                <div id="editor" class="h-full"></div>
            </div>
            
            <!-- Console -->
            <div class="console-panel p-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-semibold text-gray-300">Console Output</h3>
                    <button @click="clearConsole()" class="text-xs text-gray-400 hover:text-gray-200">
                        <i class="fas fa-trash mr-1"></i>
                        Clear
                    </button>
                </div>
                <div x-ref="console" class="text-sm whitespace-pre-wrap">
                    <div x-show="!consoleOutput" class="text-gray-400 italic">Run your code to see output here...</div>
                    <div x-html="consoleOutput"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function questionApp() {
    return {
        selectedLanguage: 'python',
        editor: null,
        isRunning: false,
        isSubmitting: false,
        consoleOutput: '',
        autoSaveInterval: null,
        
        init() {
            this.initEditor();
            this.startAutoSave();
            this.setupProctoring();
        },
        
        async initEditor() {
            require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs' }});
            
            require(['vs/editor/editor.main'], () => {
                this.editor = monaco.editor.create(document.getElementById('editor'), {
                    value: `{{ latest_submission.code if latest_submission else question.template_code or '' }}`.replace(/&quot;/g, '"').replace(/&#x27;/g, "'"),
                    language: this.getMonacoLanguage(this.selectedLanguage),
                    theme: 'vs-light',
                    automaticLayout: true,
                    minimap: { enabled: false },
                    fontSize: 14,
                    lineNumbers: 'on',
                    roundedSelection: false,
                    scrollBeyondLastLine: false,
                    readOnly: false,
                    wordWrap: 'bounded'
                });
                
                // Setup change listener for auto-save
                this.editor.onDidChangeModelContent(() => {
                    this.scheduleAutoSave();
                });
            });
        },
        
        getMonacoLanguage(lang) {
            const mapping = {
                'python': 'python',
                'cpp': 'cpp',
                'c': 'c',
                'java': 'java',
                'javascript': 'javascript'
            };
            return mapping[lang] || 'python';
        },
        
        changeLanguage() {
            if (this.editor) {
                monaco.editor.setModelLanguage(this.editor.getModel(), this.getMonacoLanguage(this.selectedLanguage));
            }
        },
        
        async runCode() {
            if (!this.editor) return;
            
            this.isRunning = true;
            this.consoleOutput = '<div class="text-blue-300">Running code...</div>';
            
            try {
                const code = this.editor.getValue();
                const response = await fetch('/api/execute-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question_id: {{ question.id }},
                        code: code,
                        language: this.selectedLanguage,
                        run_type: 'test'
                    })
                });
                
                const result = await response.json();
                
                if (result.submission_id) {
                    this.pollSubmissionStatus(result.submission_id);
                } else {
                    this.consoleOutput = '<div class="text-red-400">Failed to execute code</div>';
                }
                
            } catch (error) {
                this.consoleOutput = `<div class="text-red-400">Error: ${error.message}</div>`;
            } finally {
                this.isRunning = false;
            }
        },
        
        async submitCode() {
            if (!this.editor) return;
            
            if (!confirm('Are you sure you want to submit this solution? This will be your final submission for this question.')) {
                return;
            }
            
            this.isSubmitting = true;
            this.consoleOutput = '<div class="text-green-300">Submitting solution...</div>';
            
            try {
                const code = this.editor.getValue();
                const response = await fetch('/api/execute-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question_id: {{ question.id }},
                        code: code,
                        language: this.selectedLanguage,
                        run_type: 'submit'
                    })
                });
                
                const result = await response.json();
                
                if (result.submission_id) {
                    this.pollSubmissionStatus(result.submission_id, true);
                } else {
                    this.consoleOutput = '<div class="text-red-400">Failed to submit solution</div>';
                }
                
            } catch (error) {
                this.consoleOutput = `<div class="text-red-400">Error: ${error.message}</div>`;
            } finally {
                this.isSubmitting = false;
            }
        },
        
        async pollSubmissionStatus(submissionId, isSubmission = false) {
            let attempts = 0;
            const maxAttempts = 30; // 30 seconds timeout
            
            const poll = async () => {
                if (attempts >= maxAttempts) {
                    this.consoleOutput = '<div class="text-red-400">Execution timeout</div>';
                    this.isRunning = false;
                    this.isSubmitting = false;
                    return;
                }
                
                try {
                    const response = await fetch(`/api/submission/${submissionId}/status`);
                    const status = await response.json();
                    
                    if (status.status === 'completed') {
                        this.displayResults(status, isSubmission);
                        this.isRunning = false;
                        this.isSubmitting = false;
                    } else if (status.status === 'error') {
                        this.consoleOutput = `<div class="text-red-400">Execution failed: ${status.runtime_error || 'Unknown error'}</div>`;
                        this.isRunning = false;
                        this.isSubmitting = false;
                    } else {
                        attempts++;
                        setTimeout(poll, 1000);
                    }
                } catch (error) {
                    this.consoleOutput = `<div class="text-red-400">Error checking status: ${error.message}</div>`;
                    this.isRunning = false;
                    this.isSubmitting = false;
                }
            };
            
            poll();
        },
        
        displayResults(status, isSubmission) {
            let output = '';
            
            if (status.compilation_error) {
                output += `<div class="text-red-400 mb-2">Compilation Error:</div>`;
                output += `<div class="text-red-300 mb-4">${status.compilation_error}</div>`;
                this.consoleOutput = output;
                return;
            }
            
            if (isSubmission) {
                output += `<div class="text-green-400 mb-2">✅ Submission Complete!</div>`;
                output += `<div class="text-white mb-2">Overall Verdict: <span class="font-bold ${this.getVerdictColor(status.overall_verdict)}">${status.overall_verdict}</span></div>`;
                output += `
                  <div class="text-white mb-4">
                    Score: ${status?.total_score ?? 0}/${question?.max_score ?? 0}
                  </div>
                `;

            } else {
                output += `<div class="text-blue-400 mb-2">🔍 Test Results (Public Test Cases Only):</div>`;
            }
            
            if (status.results && status.results.length > 0) {
                status.results.forEach((result, index) => {
                    const verdictColor = this.getVerdictColor(result.verdict);
                    output += `<div class="border-t border-gray-600 pt-2 mt-2">`;
                    output += `<div class="text-gray-300">Test Case ${index + 1}: <span class="${verdictColor} font-bold">${result.verdict}</span></div>`;
                    
                    if (result.verdict === 'OK') {
                        output += `<div class="text-green-400">✅ Passed</div>`;
                    } else if (result.verdict === 'WA') {
                        output += `<div class="text-red-400">❌ Wrong Answer</div>`;
                        if (result.actual_output) {
                            output += `<div class="text-gray-300 text-xs">Your output:</div>`;
                            output += `<div class="text-gray-400 text-xs font-mono bg-gray-800 p-1 rounded">${result.actual_output.substring(0, 200)}</div>`;
                        }
                    } else {
                        output += `<div class="text-red-400">❌ ${result.verdict}</div>`;
                        if (result.error_message) {
                            output += `<div class="text-red-300 text-xs">${result.error_message}</div>`;
                        }
                    }
                    
                    output += `<div class="text-gray-400 text-xs">Time: ${result.execution_time_ms}ms | Memory: ${result.memory_used_kb}KB</div>`;
                    output += `</div>`;
                });
            }
            
            this.consoleOutput = output;
        },
        
        getVerdictColor(verdict) {
            const colors = {
                'OK': 'text-green-400',
                'WA': 'text-red-400',
                'TLE': 'text-yellow-400',
                'MLE': 'text-yellow-400',
                'RTE': 'text-red-400',
                'CE': 'text-red-400'
            };
            return colors[verdict] || 'text-gray-400';
        },
        
        clearConsole() {
            this.consoleOutput = '';
        },
        
        startAutoSave() {
            this.autoSaveInterval = setInterval(() => {
                this.performAutoSave();
            }, 30000); // Auto-save every 30 seconds
        },
        
        scheduleAutoSave() {
            // Clear existing timeout
            if (this.autoSaveTimeout) {
                clearTimeout(this.autoSaveTimeout);
            }
            
            // Schedule auto-save after 5 seconds of inactivity
            this.autoSaveTimeout = setTimeout(() => {
                this.performAutoSave();
            }, 5000);
        },
        
        async performAutoSave() {
            if (!this.editor) return;
            
            try {
                const code = this.editor.getValue();
                await fetch('/api/auto-save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question_id: {{ question.id }},
                        code: code
                    })
                });
            } catch (error) {
                console.error('Auto-save failed:', error);
            }
        },
        
        setupProctoring() {
            // Disable right-click context menu
            document.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                this.logProctoringEvent('right_click', { prevented: true });
            });
            
            // Detect common key combinations
            document.addEventListener('keydown', (e) => {
                const suspiciousKeys = [
                    'F12', // Developer tools
                    'F5',  // Refresh
                ];
                
                const suspiciousCombinations = [
                    { ctrl: true, shift: true, key: 'I' }, // Dev tools
                    { ctrl: true, shift: true, key: 'C' }, // Console
                    { ctrl: true, key: 'U' }, // View source
                ];
                
                if (suspiciousKeys.includes(e.key)) {
                    e.preventDefault();
                    this.logProctoringEvent('key_combination', { key: e.key });
                }
                
                for (const combo of suspiciousCombinations) {
                    if (e.ctrlKey === combo.ctrl && 
                        e.shiftKey === (combo.shift || false) && 
                        e.key === combo.key) {
                        e.preventDefault();
                        this.logProctoringEvent('key_combination', combo);
                    }
                }
            });
        },
        
        async logProctoringEvent(eventType, eventData) {
            try {
                await fetch('/api/proctoring-event', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        event_type: eventType,
                        event_data: eventData
                    })
                });
            } catch (error) {
                console.error('Failed to log proctoring event:', error);
            }
        }
    }
}
</script>
{% endblock %}
